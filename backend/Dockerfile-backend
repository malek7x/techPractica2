# ========================
# Stage 1: Build the application
# ========================
FROM gradle:8.7-jdk21 AS builder
WORKDIR /app

# Copy only build files first for better caching
COPY build.gradle settings.gradle ./

# Download dependencies (this layer will be cached if build files don't change)
RUN gradle dependencies --no-daemon || true

# Copy source code
COPY src ./src

# Build the application using system Gradle
RUN gradle bootJar --no-daemon

# ========================
# Stage 2: Run the application
# ========================
FROM eclipse-temurin:21-jdk
WORKDIR /app

# Copy the JAR from the build stage
COPY --from=builder /app/build/libs/*.jar app.jar

# Expose application port
EXPOSE 8080

# Start the Spring Boot app
ENTRYPOINT ["java", "-jar", "app.jar"]
